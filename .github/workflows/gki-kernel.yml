name: GKI Kernel Build (NetOpt Only)

permissions:
  contents: write
  actions: write

on:
  workflow_call:
    inputs:
      make_release:
        required: true
        type: boolean
        default: false
      android_version:
        required: true
        type: string
      kernel_version:
        required: true
        type: string
      sub_level:
        required: true
        type: string
      os_patch_level:
        required: true
        type: string
      version:
        required: false
        type: string
        default: ""
      net_opt:
        required: true
        type: boolean
        default: true

jobs:
  build-kernel-netopt:
    runs-on: ubuntu-latest
    steps:
      - name: Maximize Build Space
        uses: AdityaGarg8/remove-unwanted-software@v5
        with:
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'
          remove-docker-images: 'true'
          remove-large-packages: 'true'
          remove-swapfile: 'true'
          remove-cached-tools: 'false'

      - name: 安装依赖
        run: sudo apt update && sudo apt install -y ccache python3 git curl

      - name: 缓存 ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ${{ inputs.android_version }}-${{ inputs.kernel_version }}-${{ inputs.sub_level }}-ccache-${{ github.sha }}
          restore-keys: |
            ${{ inputs.android_version }}-${{ inputs.kernel_version }}-${{ inputs.sub_level }}-ccache-

      - name: 安装 repo 工具
        run: |
          mkdir -p ./git-repo
          curl https://storage.googleapis.com/git-repo-downloads/repo > ./git-repo/repo
          chmod a+rx ./git-repo/repo
          echo "REPO=$GITHUB_WORKSPACE/./git-repo/repo" >> $GITHUB_ENV

      - name: 设置工具链
        run: |
          AOSP_MIRROR=https://android.googlesource.com
          BRANCH=main-kernel-build-2024
          git clone $AOSP_MIRROR/kernel/prebuilts/build-tools -b $BRANCH --depth 1 kernel-build-tools
          git clone $AOSP_MIRROR/platform/system/tools/mkbootimg -b $BRANCH --depth 1 mkbootimg
          echo "AVBTOOL=$GITHUB_WORKSPACE/kernel-build-tools/linux-x86/bin/avbtool" >> $GITHUB_ENV
          echo "MKBOOTIMG=$GITHUB_WORKSPACE/mkbootimg/mkbootimg.py" >> $GITHUB_ENV
          echo "UNPACK_BOOTIMG=$GITHUB_WORKSPACE/mkbootimg/unpack_bootimg.py" >> $GITHUB_ENV

      - name: 设置 CONFIG 环境变量
        run: |
          CONFIG="${{ inputs.android_version }}-${{ inputs.kernel_version }}-${{ inputs.sub_level }}"
          echo "CONFIG=$CONFIG" >> $GITHUB_ENV

      - name: 同步 GKI 源码
        run: |
          echo "Creating folder for configuration: $CONFIG..."
          mkdir -p "$CONFIG"
          cd "$CONFIG"
          FORMATTED_BRANCH="${{ inputs.android_version }}-${{ inputs.kernel_version }}-${{ inputs.os_patch_level }}"
          $REPO init --depth=1 --u https://android.googlesource.com/kernel/manifest -b common-${FORMATTED_BRANCH} --repo-rev=v2.16
          $REPO --trace sync -c -j$(nproc --all) --no-tags --fail-fast

      - name: 追加网络优化配置
        if: ${{ inputs.net_opt }}
        run: |
          cd "$GITHUB_WORKSPACE/$CONFIG"
          CONFIG_FILE="./common/arch/arm64/configs/gki_defconfig"
          echo "[+] Target defconfig: $CONFIG_FILE"

          # Additional TTL/HL helpers
          {
            echo "CONFIG_IP_NF_TARGET_TTL=y"
            echo "CONFIG_IP6_NF_TARGET_HL=y"
            echo "CONFIG_IP6_NF_MATCH_HL=y"
          } >> "$CONFIG_FILE"

          # IP_SET core and varieties
          {
            echo "CONFIG_NETFILTER=y"
            echo "CONFIG_NETFILTER_ADVANCED=y"
            echo "CONFIG_NETFILTER_XTABLES=y"
            echo "CONFIG_IP_SET=y"
            echo "CONFIG_IP_SET_MAX=256"
            echo "CONFIG_IP_SET_BITMAP_IP=y"
            echo "CONFIG_IP_SET_BITMAP_IPMAC=y"
            echo "CONFIG_IP_SET_BITMAP_PORT=y"
            echo "CONFIG_IP_SET_HASH_IP=y"
            echo "CONFIG_IP_SET_HASH_IPMARK=y"
            echo "CONFIG_IP_SET_HASH_IPPORT=y"
            echo "CONFIG_IP_SET_HASH_IPPORTIP=y"
            echo "CONFIG_IP_SET_HASH_IPPORTNET=y"
            echo "CONFIG_IP_SET_HASH_IPMAC=y"
            echo "CONFIG_IP_SET_HASH_MAC=y"
            echo "CONFIG_IP_SET_HASH_NETPORTNET=y"
            echo "CONFIG_IP_SET_HASH_NET=y"
            echo "CONFIG_IP_SET_HASH_NETNET=y"
            echo "CONFIG_IP_SET_HASH_NETPORT=y"
            echo "CONFIG_IP_SET_HASH_NETIFACE=y"
            echo "CONFIG_IP_SET_LIST_SET=y"
            echo "CONFIG_IP_NF_SET=y"
            echo "CONFIG_IP6_NF_SET=y"
          } >> "$CONFIG_FILE"

          # iptables set extensions and useful XT targets/matches
          {
            echo "CONFIG_NETFILTER_XT_SET=y"
            echo "CONFIG_NETFILTER_XT_MATCH_SET=y"
            echo "CONFIG_NETFILTER_XT_TARGET_TPROXY=y"
            echo "CONFIG_NETFILTER_XT_TARGET_REDIRECT=y"
            echo "CONFIG_NETFILTER_XT_TARGET_MARK=y"
            echo "CONFIG_NETFILTER_XT_MATCH_SOCKET=y"
            echo "CONFIG_NETFILTER_XT_MATCH_OWNER=y"
            echo "CONFIG_NETFILTER_XT_MATCH_MARK=y"
            echo "CONFIG_NETFILTER_XT_MATCH_ADDRTYPE=y"
            echo "CONFIG_NETFILTER_XT_MATCH_MULTIPORT=y"
          } >> "$CONFIG_FILE"

          # IPv6 NAT
          {
            echo "CONFIG_NF_NAT=y"
            echo "CONFIG_IP6_NF_IPTABLES=y"
            echo "CONFIG_IP6_NF_NAT=y"
            echo "CONFIG_IP6_NF_TARGET_MASQUERADE=y"
            echo "CONFIG_IP6_NF_TARGET_NPT=y"
          } >> "$CONFIG_FILE"

          # BBR
          {
            echo "CONFIG_TCP_CONG_ADVANCED=y"
            echo "CONFIG_TCP_CONG_BBR=y"
            echo "CONFIG_NET_SCH_FQ=y"
            echo "CONFIG_TCP_CONG_WESTWOOD=y"
          } >> "$CONFIG_FILE"

      - name: 规范化 defconfig（对齐 savedefconfig）
        run: |
          set -e
          cd "$GITHUB_WORKSPACE/$CONFIG/common"
          # 生成 .config 并导出最小 defconfig，然后覆盖 gki_defconfig 以避免检查失败
          make O=out ARCH=arm64 gki_defconfig
          make O=out ARCH=arm64 savedefconfig
          cp out/defconfig arch/arm64/configs/gki_defconfig

      - name: 构建（带重试）
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 30
          max_attempts: 3
          retry_on: timeout
          command: |
            set -e
            set -x
            cd "$CONFIG"
            # 与参考工作流保持一致的预处理
            sed -i 's/BUILD_SYSTEM_DLKM=1/BUILD_SYSTEM_DLKM=0/' common/build.config.gki.aarch64 || true
            sed -i '/MODULES_ORDER=android\/gki_aarch64_modules/d' common/build.config.gki.aarch64 || true
            sed -i '/KMI_SYMBOL_LIST_STRICT_MODE/d' common/build.config.gki.aarch64 || true

            echo "Building the kernel..."
            if [ -f "build/build.sh" ]; then
              LTO=thin BUILD_CONFIG=common/build.config.gki.aarch64 build/build.sh CC="/usr/bin/ccache clang" || exit 1
            else
              tools/bazel build --disk_cache=/home/runner/.cache/bazel --config=fast --lto=thin //common:kernel_aarch64_dist || exit 1
            fi

      - name: 导出产物
        uses: actions/upload-artifact@v4
        with:
          name: gki-${{ inputs.android_version }}-${{ inputs.kernel_version }}.${{ inputs.sub_level }}-${{ inputs.os_patch_level }}
          path: |
            ${{ github.workspace }}/${{ env.CONFIG }}/bazel-bin/common/kernel_aarch64/Image
            ${{ github.workspace }}/${{ env.CONFIG }}/bazel-bin/common/kernel_aarch64/Image.lz4
            ${{ github.workspace }}/${{ env.CONFIG }}/out/${{ inputs.android_version }}-${{ inputs.kernel_version }}/dist/Image
            ${{ github.workspace }}/${{ env.CONFIG }}/out/${{ inputs.android_version }}-${{ inputs.kernel_version }}/dist/Image.lz4
